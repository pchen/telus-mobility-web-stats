"use strict";angular.module("infographicApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("infographicApp").controller("MainCtrl",["$scope","$http","$filter",function(a,b,c){a.displayGrouped=!0,a.devicesOriginal=[],a.mobileDevices=[],a.mobileDevicesAll=[],a.mobileDevicesGrouped=[],a.mobileDevicesFlatGroup=[],a.smallestResolutionDevices={},a.highestResolutionDevices={},a.mostCommonResolutionDevices={},a.filters=[{id:"ios",imgSrc:"images/ios.svg",altAttr:"Apple logo",titleAttr:"Highlight iOS devices",highlighted:!0},{id:"android",imgSrc:"images/android.svg",altAttr:"Android logo",titleAttr:"Highlight Android devices",highlighted:!0},{id:"blackberry",imgSrc:"images/blackberry.svg",altAttr:"BlackBerry logo",titleAttr:"Highlight BlackBerry devices",highlighted:!0},{id:"windows",imgSrc:"images/windows.svg",altAttr:"Windows Phone logo",titleAttr:"Highlight Windows Phone devices",highlighted:!0},{id:"webos",imgSrc:"images/webos.svg",altAttr:"webOS logo",titleAttr:"Highlight webOS devices",highlighted:!0},{id:"playstation",imgSrc:"images/playstation.svg",altAttr:"PlayStation logo",titleAttr:"Highlight PlayStation devices",highlighted:!0}],b.get("data/mobileDevices.json").then(function(b){a.devicesOriginal=b.data,a.mobileDevicesAll=c("removeZeroPixelDevices")(a.devicesOriginal),a.mobileDevicesAll=c("orderBy")(a.mobileDevicesAll,"-pxWidth"),a.mobileDevicesGrouped=c("groupDevicesBySize")(a.mobileDevicesAll),a.mobileDevicesFlatGroup=c("flattenGroupedDevices")(a.mobileDevicesGrouped),a.mobileDevicesFlatGroup=c("orderBy")(a.mobileDevicesFlatGroup,"-pxWidth"),a.mostCommonResolutionDevices=_.max(a.mobileDevicesFlatGroup,function(a){return a.count}),a.updateVis()}),a.updateVis=function(){a.mobileDevices=a.displayGrouped?a.mobileDevicesFlatGroup:a.mobileDevicesAll},a.countDevices=function(b){var b=b||a.displayGrouped;return b?a.mobileDevicesFlatGroup.length:a.mobileDevicesAll.length},a.getDeviceProperty=function(b,c){var b=b||"",c=c||"min";if(void 0===_[c])return void 0;var d=_[c].call(a,a.mobileDevicesAll,function(a){return a[b]});return d[b]},a.getDeviceNamesinArray=function(b){var c=_.pluck(a[b],"deviceName").toString();return c},a.toggleDeviceHighlight=function(b){if(b){var c=_.find(a.filters,function(a){return a.id===b});c.highlighted=!c.highlighted,a.$broadcast("EVENT_"+b.toUpperCase()+"_HIGHLIGHT_CHANGE",c)}}}]),angular.module("infographicApp").directive("telusResolutionVis",["$filter",function(){return{restrict:"E",replace:!0,template:'<div class="resolution-vis" style="width:{{visWidth}}px;height:{{visHeight}}px;">  <div id="tooltip" class="tooltip">    <h3>{{tooltipDevice.pxWidth}}px by {{tooltipDevice.pxHeight}}px</h3>    <p>      <span ng-bind-html-unsafe="tooltipDeviceDisplayName"></span>    </p>  </div>  <div>    <telus-resolution-card ng-repeat="device in mobileDevices" device="device" order="$index" offset="numCards-$index">    </telus-resolution-card>  </div></div>',scope:!0,controller:["$scope",function(a){a.predicate="-pxWidth",a.numCards=0,a.maxCardHeight=0,a.visHeight=0,a.visWidth=0,a.SCALE_SMALLER=.2,a.SCALE_LARGER=.22,a.cardScale=a.SCALE_SMALLER,a.marginTight=5,a.marginRoomy=15,a.cardLeftMargin=a.marginTight,a.cardTopMargin=0,a.selectedCard=[],a.selectedOrder,a.cardsDeactivated=!1,a.previousMouseEvent=null,a.showTooltip=!1,a.visOffset={left:0,top:0},a.tooltipDevice,a.tooltipDeviceDisplayName,this.getScaledUnit=function(b){return Math.round(b*a.cardScale)},this.getTopPositionForCard=function(b){return this.getScaledUnit(a.maxCardHeight-b)},this.getLeftPositionForCard=function(b){return(a.numCards-b)*a.cardLeftMargin},a.resetSelectedCard=function(b){return a.selectedCard&&a.selectedCard.length>0&&(a.selectedCard.removeClass("selected"),a.selectedOrder=null,a.resetAllCardLeftPositions()),b?(a.selectedOrder=angular.element(b).scope().order,b):void 0},a.setAllPointerInteractions=function(b){$("#tooltip").css("z-index",function(){return"none"===b?-1:1e3}),a.cardsDeactivated="none"===b?!0:!1,$(".resolution-card").each(function(a,c){angular.element(c).scope().order,$(c).css("pointer-events",b)})},this.getVisHeight=function(){return a.visHeight},a.positionToolTip=function(b,c){var d=$("#tooltip"),e=d.outerWidth(),f=d.outerHeight(),g=(b||0)-a.visOffset.left,h=(c||0)-a.visOffset.top,i=20,j=0,k=g+i,l=h+j;g=k+e<a.visWidth?k:g-e-i,h=l+f<a.visHeight?l:h-f-j,d.addClass("show").css({left:g,top:h})},a.hideToolTip=function(){$("#tooltip").removeClass("show").removeAttr("style")},this.getSimpleOsName=function(a){if(a){var b=a.toLowerCase();return"android"===b?"android":"ios"===b?"ios":b.indexOf("windows")>-1?"windows":b.indexOf("blackberry")>-1?"blackberry":b.indexOf("webos")>-1?"webos":b.indexOf("playstation")>-1?"playstation":void 0}}}],link:function(a,b,c,d){a.getIcon=function(a){if(a){var b=d.getSimpleOsName(a);return""!==b?'<img src="images/'+b+'.svg" width="12" height="12" alt="" />':""}},a.resetAllCardLeftPositions=function(){$(".resolution-card").each(function(a,b){var c=angular.element(b).scope().order;$(b).css("left",d.getLeftPositionForCard(c))})},a.updateTooltip=function(b){if(b){if(b.deviceName instanceof Array){var c=_.map(b.deviceName,function(c,d){return a.getIcon(b.os[d])+" "+c});a.tooltipDeviceDisplayName=c.join("<br />")}else a.tooltipDeviceDisplayName=a.getIcon(b.os)+" "+(b.deviceAlias||b.deviceName);a.$apply(function(){a.tooltipDevice=b})}},a.visOffset={left:b.offset().left,top:b.offset().top},a.positionCards=function(b){a.selectedCard=a.resetSelectedCard($(b)).addClass("selected");var c,e=a.selectedCard.next(b)[0];if(e){var f=d.getLeftPositionForCard(angular.element(e).scope().order);c=f+e.offsetWidth+a.cardLeftMargin}else c=0;$(b).css("left",c);var g=c+b.offsetWidth,h=$(b).prevUntil(b);h.each(function(b,c){var d=(b+1)*a.cardLeftMargin;$(c).css("left",g+d)})},b.on("click",".resolution-card",function(b){var c=b.target;if(a.hideToolTip(),a.selectedCard&&a.selectedCard.length>0){var d=angular.element(c).scope().order;if(a.selectedOrder&&a.selectedOrder===d)return a.resetSelectedCard(),void 0}a.positionCards(c)}),b.on("mouseenter",".resolution-card",function(b){a.updateTooltip(angular.element(b.target).scope().device)}),b.on("mousemove",function(b){-1===b.target.className.indexOf("resolution-card")?a.hideToolTip():a.positionToolTip(b.pageX,b.pageY)}),b.on("mouseleave",function(){a.hideToolTip()}),$(document).on("keydown",function(b){if(a.selectedCard&&a.selectedCard.length>0){var c;if(37===b.which?c=a.selectedCard.next(a.selectedCard)[0]:39===b.which&&(c=a.selectedCard.prev(a.selectedCard)[0]),c){a.setAllPointerInteractions("none");var d=$(a.selectedCard);d.css({cursor:"none"}),a.resetSelectedCard(c),a.positionCards(c),d.css({cursor:"pointer"})}}}),$(document).on("mousemove",function(b){if(a.cardsDeactivated){if(!a.previousMouseEvent)return a.previousMouseEvent=b,void 0;(b.pageX!==a.previousMouseEvent.pageX||b.pageY!==a.previousMouseEvent.pageY)&&(a.setAllPointerInteractions("auto"),a.previousMouseEvent=null)}}),a.$watch("mobileDevices",function(){0!==a.mobileDevices.length&&(a.numCards=a.$parent.countDevices(),a.cardScale=a.numCards<60?a.SCALE_LARGER:a.SCALE_SMALLER,a.maxCardHeight=a.$parent.getDeviceProperty("pxHeight","max"),a.visHeight=d.getScaledUnit(a.maxCardHeight)+a.cardTopMargin,a.visWidth=d.getLeftPositionForCard(0)+d.getScaledUnit(a.mobileDevices[0].pxWidth))}),a.$watch("displayGrouped",function(){a.cardLeftMargin=a.displayGrouped?a.marginRoomy:a.marginTight})}}}]),angular.module("infographicApp").directive("telusResolutionCard",["$timeout",function(a){return{require:"^telusResolutionVis",scope:{device:"=",order:"=",offset:"="},restrict:"E",replace:!0,template:'<div class="resolution-card {{deviceOsClass}}"     ng-class="{ highlight:isHighlighted, phone:isPhone, tablet:isTablet }"     ng-style="cardStyle"  >  <div class="resolution-title">    {{device.pxWidth}}    <span class="res-divider" ng-class="{ multiline:multilineResolution }" >      x    </span>    {{device.pxHeight}}    <span ng-show="device.count" class="count" ng-class="{ multiline:multilineResolution }" >      ({{device.count}})    </span>  </div></div>',controller:["$scope","$element","$attrs",function(a){a.deviceOsClass,a.isHighlighted,a.isPhone,a.isTablet,a.cardStyle,a.deviceDisplayName="",a.multilineResolution=!1,a.shadeColor=function(a,b){var c=parseInt(a,16),d=Math.round(2.55*b),e=(c>>16)+d,f=(255&c>>8)+d,g=(255&c)+d;return(16777216+65536*(255>e?1>e?0:e:255)+256*(255>f?1>f?0:f:255)+(255>g?1>g?0:g:255)).toString(16).slice(1)}}],link:function(b,c,d,e){if(0!==b.device.pxWidth||0!==b.device.pxHeight){var f,g=b.$watch("device",function(){var c=e.getVisHeight(),d=e.getTopPositionForCard(b.device.pxHeight),g=e.getScaledUnit(b.device.pxWidth),h=e.getScaledUnit(b.device.pxHeight),i=e.getLeftPositionForCard(b.order);if(b.cardStyle={width:g+"px",height:h+"px",left:i+"px",top:c+"px",opacity:0},b.$parent.displayGrouped){var j=15*(b.device.count/b.$parent.countDevices()),k=b.shadeColor("8FCBE3",-j);b.cardStyle.backgroundColor="#"+k,b.cardStyle.borderColor="#"+b.shadeColor(k,-10),b.cardStyle.color="#"+b.shadeColor(k,-30)}var l=30;if(a(function(){b.cardStyle.top=d+"px",b.cardStyle.opacity=1},b.offset*l),b.deviceDisplayName=b.device.deviceName instanceof Array?b.device.deviceName.join("<br />"):b.device.deviceAlias||b.device.deviceName,b.multilineResolution=b.device.pxWidth<360?b.device.pxHeight<=320?!1:!0:!1,b.isPhone=b.device.isPhone,b.isTablet=!b.device.isPhone,b.device.os instanceof Array||(b.deviceOsClass=e.getSimpleOsName(b.device.os)),b.deviceOsClass){var m=_.find(b.$parent.filters,function(a){return a.id===b.deviceOsClass});b.isHighlighted=m.highlighted,f=b.$on("EVENT_"+b.deviceOsClass.toUpperCase()+"_HIGHLIGHT_CHANGE",function(a,c){b.isHighlighted=c.highlighted})}});b.$on("$destroy",function(){g(),f&&f()})}}}}]),angular.module("infographicApp").filter("removeZeroPixelDevices",function(){return function(a){return _.filter(a,function(a){return 0!==a.pxWidth&&0!==a.pxHeight})}}),angular.module("infographicApp").filter("groupDevicesBySize",["$filter",function(){var a=function(a){var b,c,d=[],e=[];d=_.groupBy(a,function(a){return a.pxWidth});for(b in d){var f=_.groupBy(d[b],function(a){return a.pxHeight});e[b]=[];for(c in f)void 0===e[b][c]&&(e[b][c]=[]),e[b][c]=f[c]}return e};return a}]),angular.module("infographicApp").filter("flattenGroupedDevices",["$filter",function(){var a=function(a){var b,c,d=[];for(b in a)for(c in a[b]){var e=_.map(a[b][c],function(a){return a.deviceAlias||a.deviceName}),f=_.map(a[b][c],function(a){return a.os}),g={deviceName:e,os:f,count:e.length,pxWidth:parseInt(b,10),pxHeight:parseInt(c,10)};d.push(g)}return d};return a}]);